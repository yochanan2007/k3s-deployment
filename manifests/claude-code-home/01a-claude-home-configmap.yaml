apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-home-init
  namespace: claude-code-home
data:
  init-packages.sh: |
    #!/bin/bash
    set -e

    echo "=== Claude Code Home Package Installation ==="

    # Check if already initialized
    if [ -f /opt/tools/.initialized ]; then
      echo "Packages already installed, skipping..."
      exit 0
    fi

    # Update package lists
    apt-get update

    # Install ALL packages in one go (faster)
    echo "Installing all packages..."
    apt-get install -y --no-install-recommends \
      openssh-server \
      sudo \
      curl \
      wget \
      git \
      vim \
      nano \
      htop \
      net-tools \
      iputils-ping \
      dnsutils \
      build-essential \
      ca-certificates \
      gnupg \
      lsb-release \
      software-properties-common \
      python3 \
      python3-pip \
      python3-venv \
      python3-dev \
      jq \
      tmux \
      screen \
      tree \
      ncdu \
      rsync \
      zip \
      unzip \
      bzip2 \
      xz-utils

    # Create symlinks for python/pip
    ln -sf /usr/bin/python3 /usr/bin/python
    ln -sf /usr/bin/pip3 /usr/bin/pip

    # Install Node.js
    echo "Installing Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs

    # Install Docker CLI
    echo "Installing Docker CLI..."
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    apt-get update
    apt-get install -y docker-ce-cli docker-buildx-plugin docker-compose-plugin

    # Install kubectl
    echo "Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    install -o root -g root -m 0755 kubectl /opt/tools/kubectl
    ln -sf /opt/tools/kubectl /usr/local/bin/kubectl
    rm kubectl

    # Install yq from GitHub
    echo "Installing yq..."
    YQ_VERSION="v4.40.5"
    wget -qO /opt/tools/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
    chmod +x /opt/tools/yq
    ln -sf /opt/tools/yq /usr/local/bin/yq

    # Install ttyd for web terminal
    echo "Installing ttyd..."
    TTYD_VERSION="1.7.7"
    wget -qO /opt/tools/ttyd "https://github.com/tsl0922/ttyd/releases/download/${TTYD_VERSION}/ttyd.x86_64"
    chmod +x /opt/tools/ttyd
    ln -sf /opt/tools/ttyd /usr/local/bin/ttyd

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Create marker
    echo "$(date): Package installation completed" > /opt/tools/.initialized

    echo "=== Package Installation Complete ==="

  start-services.sh: |
    #!/bin/bash
    set -e

    echo "=== Starting Claude Code Home Services ==="

    # Install minimal packages needed for runtime (fast)
    echo "Installing runtime packages..."
    apt-get update -qq
    apt-get install -y --no-install-recommends openssh-server sudo > /dev/null 2>&1
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Create claude user if doesn't exist
    if ! id -u claude > /dev/null 2>&1; then
      echo "Creating user 'claude'..."
      groupadd -g 1000 claude
      useradd -m -u 1000 -g 1000 -s /bin/bash claude
      echo "claude:claude123" | chpasswd
      usermod -aG sudo claude
      echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
    fi

    # Set up workspace permissions
    chown -R claude:claude /home/claude/workspace

    # Configure SSH
    echo "Configuring SSH server..."
    mkdir -p /var/run/sshd
    mkdir -p /home/claude/.ssh
    chown claude:claude /home/claude/.ssh
    chmod 700 /home/claude/.ssh

    # SSH configuration
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/UsePAM yes/UsePAM no/' /etc/ssh/sshd_config
    echo "AllowUsers claude" >> /etc/ssh/sshd_config

    # Set up user environment
    if [ ! -f /home/claude/.bashrc ]; then
      cat > /home/claude/.bashrc << 'EOFBASH'
    # .bashrc for claude user

    # If not running interactively, don't do anything
    case $- in
        *i*) ;;
          *) return;;
    esac

    # History configuration
    HISTCONTROL=ignoreboth
    HISTSIZE=10000
    HISTFILESIZE=20000
    shopt -s histappend

    # Update window size after each command
    shopt -s checkwinsize

    # Colorful prompt
    PS1='\[\033[01;32m\]\u@claude-code-home\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '

    # Aliases
    alias ll='ls -alF'
    alias la='ls -A'
    alias l='ls -CF'
    alias k='kubectl'
    alias kgp='kubectl get pods'
    alias kgs='kubectl get svc'
    alias kgn='kubectl get nodes'

    # Environment variables
    export EDITOR=vim
    export PATH="/opt/tools:$HOME/.local/bin:$PATH"

    # Welcome message
    echo "==================================="
    echo "  Claude Code Development Home"
    echo "==================================="
    echo "Workspace: ~/workspace"
    echo "Tools: python, node, docker, kubectl"
    echo "Web Terminal: https://claude.k3s.dahan.house"
    echo "==================================="
    EOFBASH
      chown claude:claude /home/claude/.bashrc
    fi

    # Start SSH server in background
    echo "Starting SSH server..."
    /usr/sbin/sshd

    # Start ttyd web terminal
    echo "Starting ttyd web terminal on port 8080..."
    exec /opt/tools/ttyd \
      --port 8080 \
      --interface 0.0.0.0 \
      --credential claude:claude123 \
      --writable \
      --title-format "Claude Code Home - Terminal" \
      --max-clients 10 \
      su - claude
